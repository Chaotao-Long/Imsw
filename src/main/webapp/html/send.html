<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>聊天工具</title>
</head>
<body>
	<div>
		你好：<label id="username"></label>
	</div>
	<br>
	<br>
	<br> 请输入：
	<textarea rows="5" cols="10" id="sendMsg"></textarea>
	<button id="doSendUser" onclick="doSendUser();">发送</button>
	<button id="send" onclick="doSendUsers();">群发</button>
	<button onclick="closeWebSocket();">关闭连接</button>
	<button id="clean">清空聊天记录</button>
	<textarea rows="20" cols="40" id="receMsg"></textarea>
	<br>
	<br>
	<br>
	<br>

	<button id="start">定时发送</button>
	<button id="stop">暂时停止</button>
	<!-- 	<textarea rows="20" cols="40" id="resMsg"></textarea> -->


</body>


<script type="text/javascript"
	src="http://cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript"
	src="http://cdn.bootcss.com/sockjs-client/1.1.1/sockjs.js"></script>
<script type="text/javascript">
	// 	加载页面时触发的函数
	window.onload = function() {

		// 		从页面本地存储取出键为id的值
		var id = window.localStorage.getItem('id');
		$("#username").text(id);
	}

	// 	用条件语句匹配服务器的ip地址并建立连接
	var websocket = null;
	if ('WebSocket' in window) {
		websocket = new WebSocket(
				"ws://localhost:8080/CloudServer/websocket/socketServer");
	} else if ('MozWebSocket' in window) {
		websocket = new MozWebSocket(
				"ws://localhost:8080/CloudServer/websocket/socketServer");
	} else {
		websocket = new SockJS(
				"http://localhost:8080/CloudServer/sockjs/socketServer");
	}

	// 	连接成功触发onopen函数
	websocket.onopen = function(openEvt) {
		alert("连接成功！");
		console.log("连接状态为：" + openEvt.type);
		console.log("连接时间：" + openEvt.timeStamp);
		document.getElementById("send").disabled = false; //连接成功时启用群发按钮
	};

	// 	从服务端返回的消息
	websocket.onmessage = function(evt) { //evt根据请求不同返回不同消息
	// 		evt.data.startsWith('当前定位:');
		if (evt.data.indexOf("当前定位:") == 0) {
			$("#resMsg").append("\n").append(evt.data); //1,定时发送定位信息时返回的消息
			//console.log(evt);
		} else {
			$("#sendMsg").val(""); //发送消息后清空文本框
			$("#receMsg").append(evt.data); //2,群发时返回的消息
			//console.log(evt);
		}

	}

	// 	异常处理
	websocket.onerror = function() {
		alert("连接异常，已断开！");
		document.getElementById("send").disabled = true; //断开连接禁用按钮
	};

	// 	关闭连接
	websocket.onclose = function() {
		alert("连接已关闭");
		document.getElementById("send").disabled = true; //关闭连接禁用按钮
	};

	var time = null;
	var str = null;
	$("#start").click(function() {
		time = setInterval(function() {
			//var str1 = random(16);
			//var str2 = random(16);
			var str1 = 	"114.407061";
			var str2 = "30.553392";
			console.log("经度:"+str1); 
			console.log("纬度:"+str2); 
			let str3 = new Array(str1, str2);
	 	    let str = str3.join(',');
	 	    //console.log("经纬度:"+str); 
	 	    //console.log("");
			if (websocket.readyState == websocket.OPEN) {
				websocket.send(str);//调用后台handleTextMessage方法
				//console.log("发送成功!");
			} else {
				console.log("连接失败!");
			}
		}, 1000);
	});

	function doSendUser() {
		
		str1 = random(16);
		str2 = random(16);
		console.log(str1);
		console.log(str2);
		
		str = str1 + ',' + str2;
		console.log(str);
		
// 		let myList=new Array(str1, str2);
// 	    let pList=myList.join(',');
// 	    console.log(pList) 
		
// 		let arrNew=new Array();
// 		arrNew.push(str1);
// 		arrNew.push(str2);
// 		let strNew=arrNew.join(',');
// 		console.log(strNew);
	}

	//群发
	function doSendUsers() {

		context = $("#sendMsg").val();
		//console.log(context);
		if (context == "") {
			alert("发送消息不能为空!");
			return;
		}
		$.ajax({
			url : "http://localhost:8080/CloudServer/websocket/broad",
			type : "post",
			data : {
				"context" : context
			},
			dataType : "json",
			async : false,
			success : function(result) { //成功返回
				if (result == "200") {
					alert("发送成功！");
				}
			},
			error : function() {
				console.log("出错");
			}
		});

	}

	//关闭连接功能
	function closeWebSocket() {
		websocket.close(); //跳转到onclose方法
	}
	//		window.open("","_self");
	//		window.close();
	//		window.opener = window;
	//		var win = window.open("", "_self").close();
	//		window.close();

	//清空聊天记录
	$("#clean").click(function() {
		//alert(111);
		$("#receMsg").val("");
	});

	//随机生成长度自定义的字符串
	function random(length) {
		var str = Math.random().toString(36).substr(2);
		if (str.length >= length) {
			return str.substr(0, length);
		}
		str += random(length - str.length);
		return str;
	}

	$("#stop").click(function() {
		clearInterval(time);
	});
</script>
</html>